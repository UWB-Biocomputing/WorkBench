package edu.uwb.braingrid.workbench.ui;

import java.awt.Dimension;
import java.awt.Toolkit;
import java.awt.event.KeyEvent;
import java.util.logging.Logger;

import edu.uwb.braingrid.workbench.FileManager;

/**
 * Dialog for specifying a new simulation. This dialog is only responsible to collect information
 * from the user. All simulation construction continues within the workbench control frame.
 *
 * @author Del Davis
 */
public class NewSimulationDialog extends javax.swing.JDialog {

    // <editor-fold defaultstate="collapsed" desc="Auto-Generated Code">
    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always regenerated by the
     * Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        newSimulationNameLabel = new javax.swing.JLabel();
        newSimulationNameTextField = new javax.swing.JTextField();
        newSimulationOKButton = new javax.swing.JButton();
        newSimulationCancelButton = new javax.swing.JButton();
        newSimulationSpecificationDirectionsLabel = new javax.swing.JLabel();
        newSimulationValidationMessageLabel = new javax.swing.JLabel();
        jLabel1 = new javax.swing.JLabel();
        provenanceEnabledCheckbox = new javax.swing.JCheckBox();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("New Simulation Specification");
        setLocationByPlatform(true);
        setModal(true);

        newSimulationNameLabel.setText("Simulation Name: ");

        newSimulationNameTextField.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                newSimulationNameTextFieldKeyReleased(evt);
            }
        });

        newSimulationOKButton.setText("OK");
        newSimulationOKButton.setEnabled(false);
        newSimulationOKButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                newSimulationOKButtonActionPerformed(evt);
            }
        });

        newSimulationCancelButton.setText("Cancel");
        newSimulationCancelButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                newSimulationCancelButtonActionPerformed(evt);
            }
        });

        newSimulationSpecificationDirectionsLabel.setFont(new java.awt.Font("Tahoma", 1, 12)); // NOI18N
        newSimulationSpecificationDirectionsLabel.setText("Provide a new simulation name");

        jLabel1.setText("<html><p style=\"color:orange\">* Using the output file basename is recommended</p></html>");

        provenanceEnabledCheckbox.setSelected(true);
        provenanceEnabledCheckbox.setText("Provenance Support Enabled");
        provenanceEnabledCheckbox.setToolTipText(
                "<html>Warning: Select carefully.<br>This is permanent for the simulation<br>(i.e. you cannot turn provenance support<br>on and off after a simulation is specified)</html>");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addGroup(layout
                .createSequentialGroup().addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                        .addComponent(newSimulationSpecificationDirectionsLabel, javax.swing.GroupLayout.DEFAULT_SIZE,
                                javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addGroup(javax.swing.GroupLayout.Alignment.TRAILING,
                                layout.createSequentialGroup().addComponent(provenanceEnabledCheckbox)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED,
                                                javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                        .addComponent(newSimulationOKButton)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(newSimulationCancelButton))
                        .addGroup(layout.createSequentialGroup().addComponent(newSimulationNameLabel)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(newSimulationNameTextField))
                        .addComponent(newSimulationValidationMessageLabel, javax.swing.GroupLayout.DEFAULT_SIZE,
                                javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(jLabel1, javax.swing.GroupLayout.DEFAULT_SIZE, 399, Short.MAX_VALUE))
                .addContainerGap()));
        layout.setVerticalGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGroup(layout.createSequentialGroup().addContainerGap()
                        .addComponent(newSimulationSpecificationDirectionsLabel, javax.swing.GroupLayout.PREFERRED_SIZE,
                                19, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE,
                                javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 20, Short.MAX_VALUE)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                .addComponent(newSimulationNameLabel).addComponent(newSimulationNameTextField,
                                        javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE,
                                        javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                        .addComponent(newSimulationOKButton).addComponent(provenanceEnabledCheckbox))
                                .addComponent(newSimulationCancelButton))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(newSimulationValidationMessageLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 22,
                                javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addContainerGap()));

        pack();
    }
    // </editor-fold>//GEN-END:initComponents

    /**
     * Validates the currently entered text from the simulation name field
     *
     * Note: In order to be considered valid, the simulation name must also be a valid filename.
     * This function relies on a static method of the edu.uwb.braingrid.provenance.ProvMgr class.
     *
     * @param evt  The event that triggered this action
     */
    private void newSimulationNameTextFieldKeyReleased(java.awt.event.KeyEvent evt) {// GEN-FIRST:event_newSimulationNameTextFieldKeyReleased
        /* Redirect to OK button action if enter key */
        if (validateNewSimulationName()) {
            if (evt.getKeyCode() == KeyEvent.VK_ENTER) {
                newSimulationOKButtonActionPerformed(null);
            }
        }
    }// GEN-LAST:event_newSimulationNameTextFieldKeyReleased

    /**
     * Cancel the new simulation specification operation.
     *
     * @param evt  The event that triggered this action (cancel button clicked)
     */
    private void newSimulationCancelButtonActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_newSimulationCancelButtonActionPerformed
        isRunning = false;
        setVisible(false);
    }// GEN-LAST:event_newSimulationCancelButtonActionPerformed

    /**
     * Executes the specification of the new simulation.
     *
     * @param evt  The event that triggered this action
     */
    private void newSimulationOKButtonActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_newSimulationOKButtonActionPerformed
        specifyNewSimulation();
    }// GEN-LAST:event_newSimulationOKButtonActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel jLabel1;
    private javax.swing.JButton newSimulationCancelButton;
    private javax.swing.JLabel newSimulationNameLabel;
    private javax.swing.JTextField newSimulationNameTextField;
    private javax.swing.JButton newSimulationOKButton;
    private javax.swing.JLabel newSimulationSpecificationDirectionsLabel;
    private javax.swing.JLabel newSimulationValidationMessageLabel;
    private javax.swing.JCheckBox provenanceEnabledCheckbox;
    // End of variables declaration//GEN-END:variables
    // </editor-fold>

    // <editor-fold defaultstate="collapsed" desc="Custom Members">
    private static final Logger LOG = Logger.getLogger(NewSimulationDialog.class.getName());
    private static final long SERIAL_VERSION_UID = 1L;
    private boolean isRunning;
    private boolean success = false;
    // </editor-fold>

    // <editor-fold defaultstate="collapsed" desc="Construction">
    /**
     * Constructs and initializes this new simulation dialog.
     *
     * @param modal  True if the parent should be disabled while this dialog is open, otherwise
     *               false
     */
    public NewSimulationDialog(boolean modal) {
        LOG.info("Opening New Simulation Dialog for Sim Starter");
        initComponents();
        setModal(modal);
        isRunning = true;
        // show window center-screen
        center();
        setVisible(true);
    }

    /**
     * Centers this dialog.
     */
    private void center() {
        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();
        Dimension frameSize = getSize();
        if (frameSize.height > screenSize.height) {
            frameSize.height = screenSize.height;
        }
        if (frameSize.width > screenSize.width) {
            frameSize.width = screenSize.width;
        }
        setLocation((screenSize.width - frameSize.width) / 2,
                (screenSize.height - frameSize.height) / 2);
    }
    // </editor-fold>

    // <editor-fold defaultstate="collapsed" desc="Action Helpers">
    /**
     * Validates the simulation name against file system naming requirements.
     *
     * Note: This method relies on a static call to the ProvMgr class within the ../../provenance/
     * package.
     *
     * @return true if this simulation name is a valid file basename, otherwise false
     */
    private boolean validateNewSimulationName() {
        boolean valid = true;
        /* Validate the currently specified simulation name */
        if (!FileManager.isValidFilename(newSimulationNameTextField.getText())) {
            valid = false;
            // disable the ok button
            newSimulationOKButton.setEnabled(false);
            // set error msg
            newSimulationValidationMessageLabel.setText("<html>" + "<p style=\"color:red\"><b>"
                    + "Simulation name specified must be valid filename" + "</b></p></html>");
        } else {
            // enable the ok button
            newSimulationOKButton.setEnabled(true);
            newSimulationValidationMessageLabel.setText(null);
        }
        return valid;
    }

    private void specifyNewSimulation() {
        success = true;
        isRunning = false;
        setVisible(false);
    }
    // </editor-fold>

    // <editor-fold defaultstate="collapsed" desc="Getters">
    /**
     * Provides the name of the new simulation.
     *
     * @return The name of the new simulation
     */
    public String getSimulationName() {
        return newSimulationNameTextField.getText().replaceAll("\\s+", "_");
    }

    /**
     * Indicates whether or not provenance support should be enabled for this simulation.
     *
     * @return True if provenance support should be enabled for this simulation, otherwise false
     */
    public boolean isProvEnabled() {
        return provenanceEnabledCheckbox.isSelected();
    }

    /**
     * Indicates whether or not the user closed the dialog by selecting the OK option for creating a
     * new simulation, or the Cancel option for canceling the operation.
     *
     * @return True if the user selected OK, otherwise false
     */
    public boolean getSuccess() {
        return success;
    }

    /**
     * Indicates whether or not the new simulation dialog window is open.
     *
     * @return True if the new simulation dialog window is open, false otherwise
     */
    public boolean isRunning() {
        return isRunning;
    }
    // </editor-fold>
}
